{% extends "base.html" %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <div class="bg-white rounded-lg shadow p-6">
        <h1 class="text-2xl font-bold text-gray-800 mb-4">Scraper Control</h1>

        <!-- Status Display -->
        <div class="mb-6 p-4 bg-gray-50 rounded-lg">
            <h2 class="text-lg font-semibold mb-2">Scraper Status</h2>
            <div id="statusDisplay" class="space-y-2">
                <p>Status: <span id="statusText" class="font-medium">{{ current_job.status if current_job else 'Not
                        Running' }}</span></p>
                <p>Last Run: <span id="lastRunText" class="font-medium">{{ current_job.last_run if current_job else
                        'Never' }}</span></p>
                <p>Next Run: <span id="nextRunText" class="font-medium">{{ current_job.next_run if current_job else 'Not
                        Scheduled' }}</span></p>
                <p>Events Processed: <span id="eventsProcessedText" class="font-medium">{{ current_job.events_processed
                        if current_job else '0' }}</span></p>
                <p>Total Tickets Found: <span id="ticketsFoundText" class="font-medium">{{
                        current_job.total_tickets_found if current_job else '0' }}</span></p>
            </div>
        </div>

        <!-- Controls -->
        <div class="mb-6 space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700">Scrape Interval (minutes)</label>
                <div class="mt-1 flex items-center space-x-2">
                    <input type="number" id="intervalMinutes" min="1" value="20"
                        class="rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                        {% if current_job and current_job.status=='running' %}disabled{% endif %}>
                </div>
            </div>
        </div>

        <div class="flex items-center justify-between">
            <button id="startButton" onclick="startScraper()"
                class="bg-blue-500 text-white px-6 py-2 rounded hover:bg-blue-600">
                Start Scraper
            </button>
            <button id="stopButton" onclick="stopScraper()"
                class="bg-red-500 text-white px-6 py-2 rounded hover:bg-red-600">
                Stop Scraper
            </button>
        </div>

        <div class="mt-8">
            <h2 class="text-xl font-bold mb-4">Output Files</h2>
            <div class="bg-white rounded-lg shadow overflow-x-auto">
                <table class="min-w-full" id="filesTable">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Filename</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Created At</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Size</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Time Left</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Action</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <!-- Files will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    let statusCheckInterval;

    async function startScraper() {
        const intervalMinutes = parseInt(document.getElementById('intervalMinutes').value);
        if (intervalMinutes < 1) {
            alert('Interval must be at least 1 minute');
            return;
        }

        try {
            const response = await fetch('/api/scrape/start', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ interval_minutes: intervalMinutes })
            });

            const data = await response.json();

            if (response.ok) {
                updateUI({ status: 'running' });
                startStatusChecks();
            } else {
                showError(data.message);
            }
        } catch (error) {
            showError(error.message);
        }
    }

    async function stopScraper() {
        try {
            const response = await fetch('/api/scrape/stop', {
                method: 'POST'
            });

            const data = await response.json();

            if (response.ok) {
                updateUI({ status: 'stopped' });
                stopStatusChecks();
            } else {
                showError(data.message);
            }
        } catch (error) {
            showError(error.message);
        }
    }

    async function checkStatus() {
        try {
            const response = await fetch('/api/scrape/status');
            const data = await response.json();
            updateUI(data);
        } catch (error) {
            console.error('Error checking status:', error);
        }
    }

    function startStatusChecks() {
        statusCheckInterval = setInterval(checkStatus, 5000);  // Check every 5 seconds
    }

    function stopStatusChecks() {
        if (statusCheckInterval) {
            clearInterval(statusCheckInterval);
        }
    }

    function updateUI(data) {
        const isRunning = data.status === 'running';
        const isCompleted = data.status === 'completed';
        const isStopped = data.status === 'stopped';

        // Update buttons
        document.getElementById('startButton').style.display = isRunning || isCompleted ? 'none' : 'inline-block';
        document.getElementById('stopButton').style.display = !isRunning && !isCompleted ? 'none' : 'inline-block';
        document.getElementById('intervalMinutes').disabled = isRunning;

        // Update status display
        document.getElementById('statusText').textContent = data.status || 'Not Running';
        document.getElementById('lastRunText').textContent = data.last_run || 'Never';
        document.getElementById('nextRunText').textContent = data.next_run || 'Not Scheduled';
        document.getElementById('eventsProcessedText').textContent = data.events_processed || '0';
        document.getElementById('ticketsFoundText').textContent = data.total_tickets_found || '0';
    }

    function showError(message) {
        const result = document.getElementById('result');
        result.innerHTML = `
            <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4">
                Error: ${message}
            </div>
        `;
    }

    // Initialize status checks if scraper is running
    document.addEventListener('DOMContentLoaded', function () {
        const currentStatus = '{{ current_job.status if current_job else "stopped" }}';
        if (currentStatus === 'running') {
            startStatusChecks();
        }

        // Initialize UI with current job data
        updateUI({
            status: currentStatus,
            last_run: '{{ current_job.last_run if current_job else "" }}',
            next_run: '{{ current_job.next_run if current_job else "" }}',
            events_processed: '{{ current_job.events_processed if current_job else 0 }}',
            total_tickets_found: '{{ current_job.total_tickets_found if current_job else 0 }}'
        });
    });

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function formatTimeLeft(ageHours) {
        const hoursLeft = 24 - ageHours;
        if (hoursLeft <= 0) return 'Expired';
        return `${Math.floor(hoursLeft)} hours ${Math.round((hoursLeft % 1) * 60)} minutes`;
    }

    async function downloadFile(filename) {
        try {
            window.location.href = `/api/files/${encodeURIComponent(filename)}`;
        } catch (error) {
            alert('Error downloading file: ' + error.message);
        }
    }

    async function updateFilesList() {
        try {
            const response = await fetch('/api/files');
            const data = await response.json();

            if (data.status === 'success') {
                const tbody = document.querySelector('#filesTable tbody');
                tbody.innerHTML = '';

                if (data.files.length === 0) {
                    tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                            No output files available
                        </td>
                    </tr>
                `;
                    return;
                }

                data.files.forEach(file => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">${file.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${new Date(file.created_at).toLocaleString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${formatFileSize(file.size)}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${formatTimeLeft(file.age_hours)}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <button onclick="downloadFile('${file.name}')"
                                class="text-indigo-600 hover:text-indigo-900">
                            Download
                        </button>
                    </td>
                `;
                    tbody.appendChild(row);
                });
            }
        } catch (error) {
            console.error('Error updating files list:', error);
        }
    }

    // Add this to your existing status update interval
    setInterval(() => {
        updateFilesList();
    }, 60000); // Update every minute

    // Initial load
    document.addEventListener('DOMContentLoaded', () => {
        updateFilesList();
    });

    
</script>
{% endblock %}